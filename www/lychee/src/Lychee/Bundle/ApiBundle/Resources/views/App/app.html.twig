{% spaceless %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
    <title>{{ application.appName }}</title>
    <link rel="stylesheet" href="{{ asset('bundles/lycheeapi/app/style/detail.css') }}?v=1" />
    <link rel="stylesheet" href="{{ asset('bundles/lycheeapi/app/photoswipe/photoswipe.css') }}" />
    <link rel="stylesheet" href="{{ asset('bundles/lycheeapi/app/photoswipe/default-skin/default-skin.css') }}" />
</head>
{% set ua = userAgent() %}
<body>
<style>
	@media screen and (min-width: 480px) {
		html {
			width: 640px;
			font-size: 24px;
			margin: 0 auto;
		}
	}
</style>
{% if not ua.ciyo %}
<style>.related-topics{display:none;}</style>
{% else %}
<a class="back" href="javascript:window.history.back();" style="display:none;"></a>
{% endif %}
<div style="min-height: 35px;">
    {% if application.banner %}
        <img class="banner" src="{{ application.banner }}"/>
    {% endif %}
</div>
<div class="intro">
    <img class="icon" src="{{ application.icon | resizeImage(150, 150) }}"/>
    <span class="name">{{ application.appName }}</span>
    {% if application.publisher %}
        <span class="publisher">{{ application.publisher }}</span>
    {% endif %}
    <span class="type">{{ application.appType }}</span>
    <span class="size">{{ ua.ios ? application.iosSize : application.androidSize }} MB</span>
    <span class="playerNumbers">{{ application.playerNumbers }}人在玩</span>
    {% set downloadLink = ua.ios ? application.iosLink : application.androidLink %}
    {% if ua.android and downloadLink %}
        <a class="install" target="_blank" {{androidOk ? '' : 'disabled'}} href="{{
            androidOk ? downloadLink : "javascript:alert('你的手姬好像无法安装应用，请查看下载说明~')"
        }}">安装</a>
    {% else %}
        <a class="install" target="_blank" {{downloadLink is empty ? "disabled" : ''}} href="{{
            downloadLink is empty ? "javascript:alert('该应用暂不支持你手姬哦~')" : downloadLink
        }}">安装</a>
    {% endif %}

</div>
{% if ua.android and downloadLink %}
<div class="notice">
    <h2>下载说明</h2>
    <p>
    链接:<br/>
    {{ application.androidLink }}<br/>
    若无法下载，请长按链接复制并用自带浏览器打开<br/>
    在设置点击『版本更新』即可下载应用
    </p>
</div>
{% endif %}
<div class="description">
    <h2>内容提要</h2>
    {% set fold = application.description|length > 100 %}
    <p data-content="{{ application.description|e('html_attr') }}">{{ fold ? application.description|slice(0, 100) ~ '...' : application.description }}</p>
    {% if fold %}<button class="switch">展开</button>{% endif %}
</div>
{% if screenshots|length > 0 %}
<div class="screenshots">
    <ul>
        {% for screenshot in screenshots %}
        <li><img data-origin-src="{{ screenshot }}" data-width="720" data-height="1280" src="{{ screenshot | resizeImage(200, 0) }}" /></li>
        {% endfor %}
    </ul>
</div>
{% endif %}
{% if topics|length > 0 %}
<div class="related-topics">
    <h3>相关次元</h3>
    <ul>
        {% for topic in topics %}
        <a href="javascript:send('erciyuan://?action=view_topic&tid={{ topic.id }}')">
        <li class="topic">
            <img class="-image" src="{{
                topic.index_image is defined ? topic.index_image | resizeImage(160, 120) :
                asset('bundles/lycheewebsite/common/image/topic_default.png')
            }}"/>
            <span class="-title">{{ topic.title }}</span>
            <span class="-followed">入驻: {{ topic.followers_count }}</span>
            <span class="-posted">发布: {{ topic.post_count }}</span>
        </li>
        </a>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

<script src="{{ asset('bundles/lycheeapi/common/jquery-3.1.0.min.js') }}"></script>
<script src="{{ asset('bundles/lycheeapi/app/photoswipe/photoswipe.min.js') }}"></script>
<script src="{{ asset('bundles/lycheeapi/app/photoswipe/photoswipe-ui-default.min.js') }}"></script>
<script>
function send(url) {
    var iframe = document.createElement("iframe");
    iframe.setAttribute("src", url);
    document.documentElement.appendChild(iframe);
    iframe.parentNode.removeChild(iframe);
    iframe = null;
}

function initDescriptionFold() {
    $('.description .switch').on('click', function(e){
        var $switch = $('.description .switch');
        var content = $('.description p').data('content');
        var label = $switch.text();
        if (label == '展开') {
            $('.description p').text(content);
            if (content.length <= 100) {
                $switch.remove();
            } else {
                $switch.text('收起');
            }
        } else {
            if (content.length <= 100) {
                $('.description p').text(content);
                $switch.remove();
            } else {
                var contentText = content.substr(0, 100) + '...';
                $('.description p').text(contentText);
                $switch.text('展开');
            }
        }
    });
}

function initPhotoSwipe() {
    var items = [];
    $('.screenshots img').each(function(){
        var $img = $(this);
        var src = $img.data('origin-src');
        var width = parseInt($img.data('width'), 10);
        var height = parseInt($img.data('height'), 10);
        items.push({
            src: src,
            w: width,
            h: height
        });
    });
    $('.screenshots img').on('click', function(e){
        var index = $('.screenshots img').index(e.currentTarget);
        var options = {
            galleryUID: 1,
            getThumbBoundsFn: function(index) {
                var $img = $($('.screenshots img')[index]);
                var offset = $img.offset();
                var result = {x:offset.left, y:offset.top, w:$img.width()};
                return result;
            },
            index: index,
            shareEl: false,
            tapToClose: true,
            loop: false
        };
        var gallery = new PhotoSwipe($('.pswp')[0], PhotoSwipeUI_Default, items, options);
        gallery.init();
    });
}

$(function(){
    initDescriptionFold();
    initPhotoSwipe();

    var showBack = {{ showBack ? 1 : 0 }};
    if (showBack && window.history.length > 1) {
        $('.back').show();
    }
});
</script>
</body>
</html>
{% endspaceless %}