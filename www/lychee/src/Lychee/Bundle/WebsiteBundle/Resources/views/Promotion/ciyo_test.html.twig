{% extends 'LycheeWebsiteBundle::base.html.twig' %}

{% block meta %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="{{ block('title') }}">
{% endblock %}

{% block title %}二次元属性小测验{% endblock %}

{% set userAgent = app.request.server.get('HTTP_USER_AGENT') %}
{% set isWechat = userAgent matches '/MicroMessenger/i' %}
{% set isAndroid = userAgent matches '/Android/i' %}
{% set isIOS = userAgent matches '/\\(i[^;]+;( U;)? CPU.+Mac OS X/' %}

{% block styles %}
    {% spaceless %}
        {% if isAndroid or isIOS %}
            <link rel="stylesheet" href="{{ asset('bundles/lycheewebsite/promotion/ciyo_test/mobile.css') }}" />
        {% else %}
            <link rel="stylesheet" href="{{ asset('bundles/lycheewebsite/promotion/ciyo_test/desktop.css') }}" />
        {% endif %}
    {% endspaceless %}
{% endblock %}

{% block scripts %}
    {% include 'LycheeWebsiteBundle::wechat.html.twig' %}
    <script src="{{ asset('bundles/lycheewebsite/common/script/jquery-2.1.1.min.js') }}"></script>
    <script>
        function goto(link, fallbackLink) {
            var userAgent = navigator.userAgent;
            var inApp = /ciyocon/i.test(userAgent) === true;

            if (inApp) {
                window.location.href = link;
            } else {
                window.location.href = fallbackLink;
            }
        }

        var _page = 0;
        function prev() {
            gotoPage(_page - 1);
        }

        function next() {
            gotoPage(_page + 1);
        }

        function gotoPage(page) {
            _page = page;
            var $container = $('.warpper');
            var offsetX = $container.width() * page;
            $('.warpped').css({'transform': 'translateX(-' + offsetX + 'px)'});
        }

        function getScores() {
            var scores = {
                meng: 0, ran: 0, zhai: 0, fu: 0, jian: 0, ao: 0
            };
            $('input[type=radio]:checked').each(function(i, e){
                for (var item in scores) {
                    var dataKey = 'score' + item.charAt(0).toUpperCase() + item.substr(1);
                    var itemScore = parseInt($(e).data(dataKey));
                    if (!isNaN(itemScore)) {
                        scores[item] += itemScore;
                    }
                }
            });
            return scores;
        }

        function isLow(scores) {
            for (var item in scores) {
                if (scores[item] > 11) {
                    return false;
                }
            }
            return true;
        }

        function isHigh(scores) {
            var highCount = 0;
            for (var item in scores) {
                if (scores[item] >= 11) {
                    highCount += 1;
                }
            }
            return highCount >= 3;
        }

        function getTypes(scores) {
            var map = {meng: '萌', ran: '燃', zhai: '宅', fu: '腐', jian: '贱', ao: '傲'};
            var types = [];
            var max = 0;
            for (var item in scores) {
                if (max < scores[item]) {
                    max = scores[item];
                }
            }
            for (var item in scores) {
                if (max == scores[item]) {
                    types.push(map[item]);
                }
            }
            return types;
        }

        function getConclusion(scores) {
            if (isLow(scores)) {
                return '恭喜你，你属于<strong>阿卡林阵营</strong>！<br/>来<cite>次元</cite>一起拯救阿卡林吧～';
            } else if (isHigh(scores)) {
                return '这是今年份的膝盖！<strong>大大</strong>！<br/>现在请踩着我的尸体前进吧（躺平';
            } else {
                var types = getTypes(scores);
                return '你的二次元属性是<strong>'+types.join('、')+'</strong>。<br/>要适应你的体质哦，早日成为<cite>次元</cite>大大～';
            }
        }

        function getShareText(scores) {
            if (isLow(scores)) {
                return '阿…阿卡林？我的存在感如此之弱吗？你也来测一下嘛';
            } else if (isHigh(scores)) {
                return '我才是次元大神，颤抖吧凡人哇哈哈！不服来测！';
            } else {
                var types = getTypes(scores);
                return '我的次元属性是' + types.join('、') + '。敢不敢测一下你的？'
            }
        }

        function drawChart(scores) {
            var items = ['zhai', 'meng', 'ran', 'fu', 'jian', 'ao'];
            var points = [];
            for (var i = 0; i < items.length; ++i) {
                var score = scores[items[i]] / 18;
                var angle = i * Math.PI / 3;
                var point = Math.cos(angle) * score + ',' + (- Math.sin(angle) * score);
                points.push(point);
            }
            var pointsString = points.join(' ');
            var html = '' +
                    '<svg viewBox="-1 -1 2 2" version="1.1" xmlns="http://www.w3.org/2000/svg">' +
                    '<polygon points="' + pointsString + '" fill="#4892ba" fill-opacity="0.5">' +
                        '<animate attributeType="XML" attributeName="points" dur="1.0s" repeatCount="1"' +
                        'from="0,0 0,0 0,0 0,0 0,0 0,0"' +
                        'to="' + pointsString + '"/>' +
                        '</polygon>' +
                    '</svg>';
            var $svg = $(html);
            $('.chart').append($svg);
        }

        function retry() {
            $('input[type=radio]:checked').each(function(i, e){$(e).prop('checked', false)});
            gotoPage(0);
            $('.chart svg').remove();
            $('.conclusion').empty();
        }

        function share() {
            var maskHtml = '<div class="wechat-mask">' +
                '<img class="wechat-share-intro1" src="{{ asset('bundles/lycheewebsite/post/share/image/wechat_share_intro1.png') }}" />' +
            {% if isAndroid %}
                '<img class="wechat-download-intro" src="{{ asset('bundles/lycheewebsite/post/share/image/wechat_download_intro_android.png') }}" />' +
            {% else %}
                '<img class="wechat-download-intro" src="{{ asset('bundles/lycheewebsite/post/share/image/wechat_download_intro_ios.png') }}" />' +
            {% endif %}
                '<img class="wechat-share-intro2" src="{{ asset('bundles/lycheewebsite/post/share/image/wechat_share_intro2.png') }}" />' +
            '</div>';
            var $mask = $(maskHtml);
            $('html').append($mask);
            $mask.show();
            $mask.on('click', function(){
                $mask.remove();
                $mask = null;
            });
        }

        function setupShare() {
            wxSetupShare({
                title: '二次元属性小测验',
                link: window.location.href,
                image: 'http://www.ciyocon.com/bundles/lycheewebsite/promotion/ciyo_test/image/share.png',
                content: getShareText(getScores())
            });
        }

        $(function(){
            $('input[type=radio]').on('click', function(event){
                next();
                setupShare();
                if (_page == 7) {
                    var scores = getScores();
                    var conclusion = getConclusion(scores);
                    $('.conclusion').html(conclusion);
                    drawChart(scores);
                }
            });
        });

    </script>
{% endblock %}

{% block body %}{% spaceless %}
    <div class="warpper"><div class="warpped">
    <div class="cover">
        <img src="{{ asset('bundles/lycheewebsite/promotion/ciyo_test/image/planet.png') }}"/>
        <span>现在来玩一个<strong>小测试</strong>看看你的二次元属性!</span>
        <a href="javascript:next();">马上测试</a>
    </div>
    <ol class="questions">
        {% set questions = [
            {'title': '先给自己取个外号吧，你比较喜欢哪个?', 'name': 'waihao', 'class': 'options-square', 'options': [
                {'name': 'paojie', 'label': '炮姐', 'score':[2,3,1,0,3,2]},
                {'name': 'mengwang', 'label': '萌王', 'score':[3,0,2,2,1,0]},
                {'name': 'xionggui', 'label': '兄贵', 'score':[0,1,0,3,2,3]},
                {'name': 'jianniang', 'label': '舰娘', 'score':[1,2,3,1,0,1]},
            ]},
            {'title': '你最重要的能量来源是什么?', 'name': 'energy', 'class': 'options-square', 'options': [
                {'name': 'lv', 'label': '铝', 'score':[2,0,3,3,3,1]},
                {'name': 'cong', 'label': '葱', 'score':[3,1,2,0,1,0]},
                {'name': 'tangfen', 'label': '糖分', 'score':[1,2,0,1,2,3]},
                {'name': 'chakela', 'label': '查克拉', 'score':[0,3,1,2,0,2]},
            ]},
            {'title': '你最想拥有的超能力是?', 'name': 'skill', 'class': 'options-square', 'options': [
                {'name': 'geass', 'label': 'Geass', 'score':[0,3,0,1,3,2]},
                {'name': 'bianshen', 'label': '变身', 'score':[3,2,2,0,2,0]},
                {'name': 'seyoushu', 'label': '色诱术', 'score':[1,0,1,3,1,3]},
                {'name': 'baibaodai', 'label': '百宝袋', 'score':[2,1,3,2,0,1]},
            ]},
            {'title': '你想养什么当宠物?', 'name': 'pet', 'class': 'options-square', 'options': [
                {'name': 'qb', 'label': 'QB', 'score':[0,0,1,2,3,3]},
                {'name': 'yeye', 'label': '夜夜', 'score':[1,1,3,3,2,2]},
                {'name': 'qiaoba', 'label': '乔巴', 'score':[2,3,0,0,0,1]},
                {'name': 'maoxiansheng', 'label': '猫先生', 'score':[3,2,2,1,1,0]},
            ]},
            {'title': '你觉得以下哪句话三观很正?', 'name': 'world_view', 'class': 'options-linear', 'options': [
                {'name': 'mengjizhengyi', 'label': '萌即正义！(｡・`ω´･)　', 'score':[3,3,2,1,0,0]},
                {'name': 'heichangzhi', 'label': '黑长直统治世界!!!', 'score':[2,1,1,0,3,1]},
                {'name': 'nanhaizhi', 'label': '这么可爱一定是男孩纸！', 'score':[1,0,0,3,2,3]},
                {'name': 'fff', 'label': '烧死那些异性恋!!!', 'score':[0,2,3,2,1,2]},
            ]},
            {'title': '外文综合能力测试，你最常使用的是?', 'name': 'language', 'class': 'options-square', 'options': [
                {'name': 'prpr', 'label': 'prpr', 'score':[3,2,1,2,0,1]},
                {'name': 'cp', 'label': 'CP', 'score':[0,3,2,3,2,0]},
                {'name': '2333', 'label': '2333', 'score':[1,1,3,0,1,2]},
                {'name': 'yanbiaoqing', 'label': '(¬_¬)', 'score':[2,0,0,1,3,3]},
            ]},
        ] %}

        {% for question in questions %}
        <li>
            <h2>{{ question.title }}</h2>
            <ul class="{{ question.class }}">
                {% for option in question.options %}
                <li class="option">
                    <input type="radio"
                           name="{{ question.name }}"
                           id="{{ option.name }}"
                           value="{{ option.name }}"
                           autocomplete="off"
                           {% for score_key in ['meng', 'ran', 'zhai', 'fu', 'ao', 'jian'] %}
                             {% if option.score[loop.index0] > 0 %}
                                data-score-{{ score_key }}="{{ option.score[loop.index0] }}"
                             {% endif %}
                           {% endfor %}
                            />
                    <label for="{{ option.name }}">
                        <img src="{{ asset("bundles/lycheewebsite/promotion/ciyo_test/image/#{option.name}.png") }}"/>
                        <span>{{ option.label }}</span>
                    </label>
                </li>
                {% endfor %}
            </ul>
            <a class="prev" href="javascript:prev()">上一题</a>
        </li>
        {% endfor %}
    </ol>
    <div class="result">
        <div class="chart">
            <div class="zhai"></div>
            <div class="meng"></div>
            <div class="ran"></div>
            <div class="fu"></div>
            <div class="jian"></div>
            <div class="ao"></div>
            {#<svg viewBox="-1 -1 2 2" version="1.1" xmlns="http://www.w3.org/2000/svg">#}
                {#<polygon points="1,0 0.5,0.87 -0.5,0.87 -1,0 -0.5,-0.87 0.5,-0.87" fill="#4892ba" fill-opacity="0.5">#}
                    {#<animate attributeType="XML" attributeName="points" dur="0.75s" repeatCount="1"#}
                             {#from="0,0 0,0 0,0 0,0 0,0 0,0"#}
                             {#to="1,0 0.5,0.87 -0.5,0.87 -1,0 -0.5,-0.87 0.5,-0.87"/>#}
                {#</polygon>#}
            {#</svg>#}
        </div>
        {#<p class="conclusion">恭喜你，你属于<strong>阿卡林阵营</strong>！<br/>来<cite>次元</cite>一起拯救阿卡林吧～</p>#}
        {#<p class="conclusion">你的二次元属性是<strong>宅、萌、燃、腐、贱</strong>。<br/>要适应你的体质哦，早日成为<cite>次元</cite>大大～</p>#}
        {#<p class="conclusion">这是今年份的膝盖！<strong>大大</strong>！<br/>现在请踩着我的尸体前进吧（躺平</p>#}
        <p class="conclusion"></p>
        <p class="links">
            <a class="again" href="javascript:retry();">再玩一次</a>
            <a class="download" href="{{ url('download_app') }}">进入次元社</a>
            {% if isWechat %}
                <a class="share" href="javascript:share();">晒一晒</a>
            {% endif %}
        </p>
    </div>
    </div></div>
{% endspaceless %}{% endblock %}