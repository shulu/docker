{% extends 'LycheeAdminBundle:Topic:layout.html.twig' %}

{% block body %}
    <button type="button" class="btn btn-primary pull-left" data-toggle="modal" data-target="#create_topic">
        <span class="glyphicon glyphicon-plus"></span>
    </button>
    <div class="clearfix">
        <div class="col-lg-4 pull-right">
            <form>
                <div class="input-group">
                    <input type="text" name="query" class="form-control" placeholder="次元名称或ID" value="{{ query|default('') }}">
                <span class="input-group-btn">
                    <button class="btn btn-primary" type="submit">搜索</button>
                </span>
                </div><!-- /input-group -->
            </form>
        </div><!-- /.col-lg-6 -->
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>ID</th>
                <th>标题</th>
                <th>创建时间</th>
                <th>帖子数量</th>
                <th>角标</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="topic_tbody">
            {% for topic in topics %}
                <tr class="{{ topic.deleted? 'danger' }}">
                    <td><a href="{{ path('lychee_admin_topic_detail', {topicId: topic.id}) }}" target="_blank">{{ topic.id }}</a></td>
                    <td>{{ topic.title }}</td>
                    <td>{{ topic.createTime|date('Y-m-d H:i:s') }}</td>
                    <td>{{ topic.postCount }}</td>
                    <td>{{ topic.opMark }}</td>
                    <td>{{ topic.deleted? '已删除':'活跃' }}</td>
                    <td>
                        {% if not topic.deleted %}
                        <button type="button" class="btn btn-default topic-edit" data-id="{{ topic.id }}" onclick="topicEdit(this)">
                            <span class="glyphicon glyphicon-edit"></span>
                        </button>
                        {% if topic.hidden %}
                            <button type="button" class="btn btn-default topic-hide" data-id="{{ topic.id }}" onclick="topicHide(this)">取消隐蔽</button>
                        {% else %}
                            <button type="button" class="btn btn-default topic-hide" data-id="{{ topic.id }}" onclick="topicHide(this)">隐蔽</button>
                        {% endif %}
                        <button type="button" class="btn btn-danger topic-remove" data-id="{{ topic.id }}" onclick="topicRemove(this)">
                            <span class="glyphicon glyphicon-trash"></span>
                        </button>
                        {% endif %}
                        <a class="btn btn-success" href="{{ path('lychee_admin_topic_post', {id: topic.id}) }}">
                            查看所有帖子
                        </a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <input type="hidden" id="topic_remove_url" value="{{ path("lychee_admin_topic_remove") }}">
    <input type="hidden" id="topic_hide_url" value="{{ path("lychee_admin_topic_hideorunhidetopic") }}">
    <input type="hidden" id="next_cursor" value="{{ nextCursor }}">
    {% if paginator is not null %}
        {% import 'LycheeAdminBundle::helper.html.twig' as helper %}
        {{ helper.pagination(paginator, app.request.get('_route')) }}
    {% else %}
        {% if nextCursor != 0 %}
            <div class="load-more-wrap"><button class="btn btn-default" id="load_more_topics">加载更多</button></div>
        {% endif %}
    {% endif %}
    {{ include('LycheeAdminBundle:Topic:topicForm.html.twig', {
        'topicName': topic_name,
        'formPath': path('lychee_admin_topic_create'),
        'properties': properties,
        'categories': categories,
        'topicFetchUrl': path('lychee_admin_topic_fetchone')
    }) }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets '@fileinput_css' filter="cssrewrite" %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
    <style>
        tr.danger {
            opacity: 0.5;
        }
        .load-more-wrap { margin-bottom: 20px; }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% javascripts '@fileinput_js' %}
    <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    {% javascripts '@LycheeAdminBundle/Resources/public/js/topic_form.js' %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script>
        function joinTopicTableRow(topic) {
            var deleteClass = topic.deleted? 'danger':'';
            var isDelete = topic.deleted? '已删除':'活跃';
            var topicDetailUrl = '/topic/detail/' + topic.id;
            var topicPostUrl = '/topic/post/' + topic.id;
            var rowStr = '<tr class="' + deleteClass + '">' +
                    '<td><a href="' + topicDetailUrl + '" target="_blank">' + topic.id + '</a></td>' +
                    '<td>' + topic.title + '</td>' +
                    '<td>' + topic.createTime + '</td>' +
                    '<td>' + topic.postCount + '</td>' +
                    '<td>' + topic.opMark + '</td>' +
                    '<td>' + isDelete + '</td>' +
                    '<td>';
            if (!topic.deleted) {
                rowStr += '<button type="button" class="btn btn-default topic-edit" data-id="' + topic.id + '" onclick="topicEdit(this)">' +
                        '<span class="glyphicon glyphicon-edit"></span></button> ';
                if (topic.hidden) {
                    var topicHideStr = '取消隐藏';
                } else {
                    var topicHideStr = '隐藏';
                }
                rowStr += '<button type="button" class="btn btn-default topic-hide" data-id="' + topic.id + '" onclick="topicHide(this)">' + topicHideStr + '</button> ';
                rowStr += '<button type="button" class="btn btn-danger topic-remove" data-id="' + topic.id + '" onclick="topicRemove(this)">' +
                        '<span class="glyphicon glyphicon-trash"></span></button> ';
            }
            rowStr += '<a class="btn btn-success" href="' + topicPostUrl + '">查看所有帖子</a></td></tr>';
            return rowStr;
        }
        $(document).ready(function () {
            var $imageInput = $(".index_image");
            var fileinputConfig = {
                allowedFileTypes: ['image'],
                showUpload: false
            };
            $imageInput.fileinput(fileinputConfig);

            $('#load_more_topics').click(function() {
                var $loadMoreBtn = $(this);
                $loadMoreBtn.text('加载中……');
                $.ajax('{{ path("lychee_admin_topic_loadmoretopics") }}', {
                    dataType: "json",
                    data: {
                        cursor: $('#next_cursor').val(),
                        keyword: '{{ query }}'
                    },
                    complete: function() {
                        $loadMoreBtn.text('加载更多');
                    },
                    success: function(data) {
                        var listStr = '';
                        for (var index in data.topics) {
                            listStr += joinTopicTableRow(data.topics[index]);
                        }
                        if (listStr) {
                            $('#topic_tbody').append(listStr);
                        }
                        $('#next_cursor').val(data.cursor);
                        if (0 == data.cursor) {
                            $loadMoreBtn.hide();
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}