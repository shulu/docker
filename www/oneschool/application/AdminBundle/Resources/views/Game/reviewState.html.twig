{% extends 'LycheeAdminBundle:Game:layout.html.twig' %}
{% block body %}
    <button type="button" id="create_reviewstate_btn" class="btn btn-primary" data-toggle="modal"
            data-target="#create_reviewstate_form">
        <span class="glyphicon glyphicon-plus"></span>
    </button>
    {% if reviewstates | length > 0%}
        <ul class="nav nav-tabs">
            {% for appId in appIds %}
                <li role="presentation" class="{% if currentApp == appId %}active{% endif %}">
                    <a href="{{ path('lychee_admin_game_reviewstate', {app: appId}) }}">{{ appId == 1 ? "次元社" : "异次元通讯" }}</a>
                </li>
            {% endfor %}
        </ul>

        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th>渠道名称</th>
                    <th>上架版本号</th>
                    <th>开启状态</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                    {% for reviewstate in reviewstates %}
                        <tr>
                            <td>
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" value="{{ reviewstate.id }}" data-state="{{ reviewstate.inReview }}"> {{ reviewstate.channel }}
                                    </label>
                                </div>
                            </td>
                            <td>{{ reviewstate.version }}</td>
                            <td>{{ reviewstate.inReview ? "已开启" : "已关闭" }}</td>
                            <td>
                                <button class="btn btn-default edit-version" data-toggle="modal" data-target="#edit_version_form" data-version="{{ reviewstate.version }}" data-reviewstate-id="{{ reviewstate.id }}" data-reviewstate-app="{{ currentApp }}" data-page="{{ page ? page : 1 }}">
                                    <span class="glyphicon glyphicon-edit"></span>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="row">
            <div class="col-sm-offset-1 col-sm-2">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="select_all"> 全选
                    </label>
                </div>
            </div>
            <div class="col-sm-2">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="inverse_select"> 反选
                    </label>
                </div>
            </div>
            <div class="col-sm-offset-1 col-sm-3">
                <button class="btn btn-default" id="open" data-app-id="{{ currentApp }}" data-page="{{ page ? page : 1 }}">开启游戏模块</button>
            </div>
            <div class="col-sm-3">
                <button class="btn btn-default" id="close" data-app-id="{{ currentApp }}" data-page="{{ page ? page : 1 }}">关闭游戏模块</button>
            </div>
        </div>
        <nav>
            <ul class="pagination">
                <li>
                    <a href="{{ path('lychee_admin_game_reviewstate', {app: currentApp, page: 1}) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% if pageCount < 1 %}{% set pageCount = 1 %}{% endif %}
                {% for p in 1..min(10, pageCount) %}
                    <li class="{{ p==page? 'active' }}">
                        <a href="{{ path('lychee_admin_game_reviewstate', {app: currentApp, page: p}) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                <li>
                    <a href="{{ path('lychee_admin_game_reviewstate', {app: currentApp, page: pageCount}) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    {% endif %}
    <!-- Modal -->
    <div class="modal fade" id="create_reviewstate_form" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">添加游戏渠道</h4>
                </div>
                <form role="form" method="post" action="{{ path('lychee_admin_game_addreviewstate') }}"
                      enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="channel">渠道名称</label>
                            <input type="text" name="channel" id="channel" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="version">上架版本号</label>
                            <input type="text" name="version" id="version" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="app_id">游戏应用</label>
                            <select class="form-control" id="app_id" name="app_id">
                                {% if appIds | length > 0 %}
                                    {% for appId in appIds  %}
                                        <option value="{{ appId }}" {% if appId == currentApp %} selected {% endif %}>{{ appId == 1 ? "次元社" : "异次元通讯" }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>注意：添加的新渠道开启状态为<b style="color: red">默认关闭</b>,如需修改，添加后手动修改该状态</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary create-reviewstate">保 存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="edit_version_form" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">修改版本号</h4>
                </div>
                <form role="form" method="post" action="{{ path('lychee_admin_game_editversion') }}">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new_version">版本号</label>
                            <input type="text" class="form-control" id="new_version" name="new_version">
                            <input type="hidden" class="form-control" id="app_id" name="app_id">
                            <input type="hidden" class="form-control" id="reviewstate_id" name="reviewstate_id">
                            <input type="hidden" class="form-control" id="page" name="page">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="edit_version_submit">修改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .nav-tabs { margin-bottom: 10px; }
    </style>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="application/javascript">
        $(document).ready(function () {
            $('.edit-version').click(function () {
                $('#edit_version_form #new_version').val($(this).data('version'));
                $('#edit_version_form #app_id').val($(this).data('reviewstate-app'));
                $('#edit_version_form #reviewstate_id').val($(this).data('reviewstate-id'));
                $('#edit_version_form #page').val($(this).data('page'));
            });
            $('#edit_version_submit').click(function () {
                if(!$('#edit_version_form #new_version').val()) {
                    alert('版本信息不能为空');
                    return false;
                }
            });
            $('.create-reviewstate').click(function () {
                if(!$('#create_reviewstate_form #channel').val()) {
                    alert('渠道名称不能为空');
                    return false;
                }
                if (!$('#create_reviewstate_form #version').val()) {
                    alert('版本信息不能为空');
                    return false;
                }
            });
            $('#select_all').change(function () {
                var ischeck = $(this).is(":checked");
                if (ischeck) {
                    $('.table input[type="checkbox"]').each(function () {
                        if (!$(this).is(":checked")) {
                            $(this).prop('checked', true)
                        }
                    });
                }
                else {
                    $('.table input[type="checkbox"]').each(function () {
                        if ($(this).is(":checked")) {
                            $(this).prop('checked', false)
                        }
                    });
                }
            });
            $('#inverse_select').change(function () {
                $('.table input[type="checkbox"]').each(function () {
                    if (!$(this).is(":checked")) {
                        $(this).prop('checked', true)
                    }
                    else {
                        $(this).prop('checked', false)
                    }
                });
            });

            $('#open').click(function () {
                var state = 1;
                var reviewstateIds = [];
                var appId = $(this).data('app-id');
                var page = $(this).data('page');
                var selectedCheckboxs = $('.table input:checked');
                if (!selectedCheckboxs.length) {
                    alert("请选中某一条记录再操作");
                    return false;
                }
                if (selectedCheckboxs.length == 1) {
                   if (selectedCheckboxs.data('state')) {
                       alert('该渠道已经是开启状态');
                       return false;
                   }
                }
                selectedCheckboxs.each(function () {
                    reviewstateIds.push($(this).val());
                });
                var $form = $('<form></form>');
                $form.attr("action", "{{ path('lychee_admin_game_editreviewstate') }}");
                $form.attr("method", "post");
                $form.append('<input type="hidden", name="reviewstate_ids" value="' + reviewstateIds + '">');
                $form.append('<input type="hidden", name="app_id" value="' + appId + '">');
                $form.append('<input type="hidden", name="state" value="' + state + '">');
                $form.append('<input type="hidden", name="page" value="' + page + '">');
                $("body").append($form);
                $form.submit();
            })
            $('#close').click(function () {
                var state = 0;
                var reviewstateIds = [];
                var appId = $(this).data('app-id');
                var page = $(this).data('page');
                var selectedCheckboxs = $('.table input:checked');
                if (!selectedCheckboxs.length) {
                    alert("请选中某一条记录再操作");
                    return false;
                }
                if (selectedCheckboxs.length == 1) {
                    if (!selectedCheckboxs.data('state')) {
                        alert('该渠道已经是关闭状态');
                        return false;
                    }
                }
                selectedCheckboxs.each(function () {
                    reviewstateIds.push($(this).val());
                });
                var $form = $('<form></form>');
                $form.attr("action", "{{ path('lychee_admin_game_editreviewstate') }}");
                $form.attr("method", "post");
                $form.append('<input type="hidden", name="reviewstate_ids" value="' + reviewstateIds + '">');
                $form.append('<input type="hidden", name="app_id" value="' + appId + '">');
                $form.append('<input type="hidden", name="state" value="' + state + '">');
                $form.append('<input type="hidden", name="page" value="' + page + '">');
                $("body").append($form);
                $form.submit();
            })
        });
    </script>
{% endblock %}