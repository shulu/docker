{% extends 'LycheeAdminBundle:PostManager:layout.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets '@LycheeAdminBundle/Resources/public/datepicker2/css/bootstrap-datetimepicker.min.css' %}
        <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}

    <style>
        th { text-align: center; }
        a.operation { white-space: nowrap; }
    </style>
{% endblock %}

{% block bodyInner %}

    <div class="clearfix">
        <form class="form-inline">
            <div class="form-group">
                <label class="control-label" for="date">发帖时间</label>
                <input type="text" class="form-control datepicker"  data-date-view="day" data-date-format="yyyy-mm-dd"  name="query[date]" value="{{ query.date }}">
            </div>
            <div class="form-group">
                操作来源
            <select name="query[source]" class="form-control">
                <option value="0">全部</option>
                {% for key, source in sources %}
                    <option value="{{ key }}" {% if key == query.source  %} selected {% endif %}   >{{ source }}</option>
                {% endfor %}
            </select>
            </div>
            <button type="submit" class="btn btn-primary">查询</button>
        </form>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>用户</th>
                    <th>{{ topic_name }}</th>
                    <th>创建时间</th>
                    <th>内容</th>
                    <th>图片</th>
                    <th>视频</th>
                    <th>音频</th>
                    <th>网页</th>
                    <th>操作来源</th>
                    <th><span class="glyphicon glyphicon-wrench"></span></th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts %}
                    <tr>
                        <td>
                            <a href="{{ path('lychee_admin_postmanager_detail', {id: post.id}) }}" target="_blank">
                                {{ post.id }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ path('lychee_admin_usermanagement_index', {query: post.authorId}) }}" target="_blank">
                                {{ authors[post.authorId].nickname }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ path('lychee_admin_topic_detail', {topicId: post.topicId}) }}" target="_blank">
                                {{ topics[post.topicId].title }}
                            </a>
                        </td>
                        <td>{{ post.createTime|date('Y-m-d H:i') }}</td>
                        <td>{{ post.content }}</td>
                        <td>
                            {% if post.imageUrl is not empty %}
                                <img src="{{ post.imageUrl }}" class="img-thumbnail" style="max-width: 80px; max-height: 80px;"/>
                            {% endif %}
                        </td>
                        <td>
    {% if post.videoUrl is not empty %}

        <video src="{{ post.videoUrl }}" poster="{{ post.imageUrl }}" height="150" controls preload="none" >
            {{ post.videoUrl }}
        </video>

    {% endif %}
                        </td>
                        <td><a href="{{ post.audioUrl }}" target="_blank">{{ post.audioUrl }}</a></td>
                        <td><a href="{{ post.siteUrl }}" target="_blank">{{ post.siteUrl }}</a></td>
                        <td>{{ post.source }}</td>
                        <td>
                            <button type="button" class="btn btn-primary recover-post" data-id="{{ post.id }}"  >恢复</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% import 'LycheeAdminBundle::helper.html.twig' as helper %}
    {% if paginator is not null %}
        {{ helper.newpage(paginator, app.request.get('_route'), query) }}
    {% endif %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% javascripts filter='?jsqueeze' output='js/rejected_audit_posts.js'
        '@LycheeAdminBundle/Resources/public/datepicker2/js/bootstrap-datetimepicker.min.js'
        '@LycheeAdminBundle/Resources/public/datepicker2/js/locales/bootstrap-datetimepicker.zh-CN.js'
        '@LycheeAdminBundle/Resources/public/js/datepicker.js'
    %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

    <script>
        $(document).ready(function() {

            $(".recover-post").click(function () {
                if (confirm("确定恢复帖子？")) {
                    var $recoverBtn = $(this);
                    var postId = $recoverBtn.data("id");
                    $.ajax("{{ path('lychee_admin_contentaudit_recoverpost') }}", {
                        type: "post",
                        dataType: "json",
                        data: {
                            id: postId
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            if (jqXHR.status == '404') {
                                alert('帖子不存在。');
                            } else {
                                alert("服务器发生错误！");
                            }
                        },
                        success: function() {
                            window.location.reload();
                        }
                    });
                }
                return false;
            });

        });
    </script>
{% endblock %}