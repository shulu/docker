{% extends 'LycheeAdminBundle:List:layout.html.twig' %}
{% import 'LycheeAdminBundle::helper.html.twig' as helper %}

{% block body %}
    {% set typeUser = constant('Lychee\\Bundle\\AdminBundle\\Service\\GrayListService::TYPE_USER') %}
    {% set typeTopic = constant('Lychee\\Bundle\\AdminBundle\\Service\\GrayListService::TYPE_TOPIC') %}
    {% set sortByCount = constant('Lychee\\Bundle\\AdminBundle\\Service\\GrayListService::SORT_BY_DELETE_COUNT') %}
    {% set sortByTime = constant('Lychee\\Bundle\\AdminBundle\\Service\\GrayListService::SORT_BY_DELETE_TIME') %}
    <div>
        <form class="form-inline">
            <div class="form-group">
                <label>查询类型</label>
                <select name="type" class="form-control">
                    <option value="{{ typeUser }}" {{ type==typeUser? 'selected' }}>用户</option>
                    <option value="{{ typeTopic }}" {{ type==typeTopic? 'selected' }}>次元</option>
                </select>
            </div>
            <div class="form-group">
                <label>排序方式</label>
                <select name="sort" class="form-control">
                    <option value="{{ sortByTime }}" {{ sort==sortByTime? 'selected' }}>最后删除时间</option>
                    <option value="{{ sortByCount }}" {{ sort==sortByCount? 'selected' }}>被删除总数</option>
                </select>
            </div>
            <button type="submit" class="btn btn-default">查询</button>
        </form>
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>{{ type == typeUser? '用户':'次元' }}ID</th>
                    {% if type == typeUser %}
                        <th>头像</th>
                        <th>昵称</th>
                        <th>创建时间</th>
                        <th>状态</th>
                        <th>领主次元</th>
                    {% else %}
                        <th>次元名</th>
                        <th>帖子数</th>
                        <th>成员数</th>
                        <th>领主</th>
                    {% endif %}
                    <th>最近被删时间</th>
                    <th>累计被删帖(次)</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for l in list %}
                    <tr>
                        <td>
                            <a href="
                            {% if type == typeUser %}
                                {{ path('lychee_admin_contentaudit_userdetail', {userId: l.0}) }}
                            {% else %}
                                {{ path('lychee_admin_topic_detail', {topicId: l.0}) }}
                            {% endif %}
                            " target="_blank">{{ l.0 }}</a>
                        </td>
                        {% if type == typeUser %}
                            {% set user = users[l.0] %}
                            <td>
                                <img src="{{ user.avatarUrl|resizeImage(0, 50) }}" alt="" height="50">
                            </td>
                            <td>{{ user.nickname }}</td>
                            <td>{{ user.createTime|date('Y-m-d H:i') }}</td>
                            <td>{{ user.frozen == 0? '正常':'冻结' }}</td>
                            <td>
                                {% for topic in managerTopics[user.id] %}
                                    <p>
                                        {% if topic %}
                                            <a href="{{ path('lychee_admin_topic_detail', {topicId: topic.id}) }}" target="_blank">
                                                {{ topic.title }}
                                            </a>
                                        {% else %}
                                            <a href="{{ path('lychee_admin_contentaudit_managertopics', {managerId: user.id}) }}"
                                               target="_blank">更多...</a>
                                        {% endif %}
                                    </p>
                                {% endfor %}
                            </td>
                        {% else %}
                            {% set topic = topics[l.0] %}
                            <td>{{ topic.title }}</td>
                            <td>{{ topic.postCount }}</td>
                            <td>{{ topic.followerCount }}</td>
                            <td>
                                [<a href="{{ path('lychee_admin_contentaudit_userdetail', {userId: topic.managerId}) }}">
                                    {{ topic.managerId }}
                                </a>]
                                {{ topicManagers[topic.managerId].nickname }}
                            </td>
                        {% endif %}
                        <td>{{ l.1|date('Y-m-d H:i:s') }}</td>
                        <td>{{ l.2 }}</td>
                        {% if type == typeUser %}
                            {% set user = users[l.0] %}
                            <td>
                                <button type="button" class="btn btn-default chat" data-user-id="{{ user.id }}"
                                        data-uesr-nickname="{{ user.nickname }}">
                                    <span class="glyphicon glyphicon-envelope"></span>
                                </button>
                                {% if false == user.frozen %}
                                    <button type="button" class="btn btn-danger black-list" uid="{{ user.id }}">
                                        <span class="glyphicon glyphicon-trash"></span>
                                    </button>
                                    <a href="{{ path('lychee_admin_contentaudit_postlistbyauthor', {'authorId': user.id}) }}"
                                        target="_blank">
                                        查看所有帖子
                                    </a>
                                {% else %}
                                    <button class="btn btn-default frozen_user_renew" user_id="{{ user.id }}">恢复</button>
                                {% endif %}
                                {% if user.id in deviceBlock %}
                                    <button class="btn btn-default device_unblock" data-user-id="{{ user.id }}">恢复设备</button>
                                {% endif %}
                            </td>
                        {% else %}
                            {% set topic = topics[l.0] %}
                            <td>
                                {% if not topic.deleted %}
                                    {% if topic.hidden %}
                                        <button type="button" class="btn btn-default topic-hide" data-id="{{ topic.id }}" onclick="topicHide(this)">取消隐蔽</button>
                                    {% else %}
                                        <button type="button" class="btn btn-default topic-hide" data-id="{{ topic.id }}" onclick="topicHide(this)">隐蔽</button>
                                    {% endif %}
                                    <button type="button" class="btn btn-danger topic-remove" data-id="{{ topic.id }}" onclick="topicRemove(this)">
                                        <span class="glyphicon glyphicon-trash"></span>
                                    </button>
                                {% endif %}
                                <a class="btn btn-success" href="{{ path('lychee_admin_topic_post', {id: topic.id}) }}">
                                    查看所有帖子
                                </a>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <nav>
            <ul class="pagination">
                <li>
                    <a href="{{ path('lychee_admin_list_graylist',
                    {type: type, sort: sort, page: 1, count: app.request.get('count')}) }}"
                       aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% for p in 1..pageCount %}
                    <li class="{{ p==page? 'active' }}">
                        <a href="{{ path('lychee_admin_list_graylist',
                        {type: type, sort: sort, page: p, count: app.request.get('count')}) }}">
                            {{ p }}
                        </a>
                    </li>
                {% endfor %}
                <li>
                    <a href="{{ path('lychee_admin_list_graylist',
                    {type: type, sort: sort, page: pageCount, count: app.request.get('count')}) }}"
                       aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        {{ helper.chatWin(ciyoUser) }}
        {{ helper.freeUser() }}
        <input type="hidden" id="topic_remove_url" value="{{ path("lychee_admin_topic_remove") }}">
        <input type="hidden" id="topic_hide_url" value="{{ path("lychee_admin_topic_hideorunhidetopic") }}">
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% javascripts '@LycheeAdminBundle/Resources/public/js/topic_form.js' %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script>
        $(document).ready(function() {
            $(".frozen_user_renew").on("click", function() {
                if (true === confirm("确定恢复此帐号？")) {
                    $.ajax("{{ path('lychee_admin_contentaudit_unfreezeuser') }}", {
                        type: "POST",
                        dataType: "json",
                        data: {
                            user_id: $(this).attr("user_id")
                        },
                        success: function() {
                            window.location.reload();
                        },
                        error: function() {
                            alert("发生未知错误！");
                        }
                    });
                }
            });
            $('.device_unblock').click(function() {
                if (!confirm('确定恢复用户设备？')) {
                    return false;
                }
                var userId = $(this).data('user-id');
                var $form = $('<form method="post"></form>');
                $form.attr('action', '{{ path("lychee_admin_contentaudit_unblockdevice") }}');
                $form.append('<input type="hidden" name="user_id" value="' + userId + '">');
                $('body').append($form);
                $form.submit();
            });
        });
    </script>
{% endblock %}