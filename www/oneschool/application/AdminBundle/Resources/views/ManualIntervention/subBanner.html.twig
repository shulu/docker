{% extends 'LycheeAdminBundle:ManualIntervention:layout.html.twig' %}

{% block body %}
    <button type="button" id="create_item_btn" class="btn btn-primary pull-right" data-toggle="modal"
            data-target="#create_item_form">
        <span class="glyphicon glyphicon-plus"></span>
        <span>广告位</span>
    </button>
    <ul class="nav nav-tabs">
        <li role="presentation" class="{{ app.request.get('type') is null? 'active' }}">
            <a href="{{ path('lychee_admin_manualintervention_subbanner') }}">已发布</a>
        </li>
        <li role="presentation" class="{{ 'unpublished' == app.request.get('type')? 'active' }}">
            <a href="{{ path('lychee_admin_manualintervention_subbanner', {type: 'unpublished'}) }}">未发布</a>
        </li>
        <li role="presentation" class="{{ 'deleted' == app.request.get('type')? 'active' }}">
            <a href="{{ path('lychee_admin_manualintervention_subbanner', {type: 'deleted'}) }}">已删除</a>
        </li>
    </ul>
    {% if app.request.get('type') is null %}
        <div class="container-fluid" style="margin-top: 20px;">
            <div class="row">
                <ul class="sortable grid">
                    {% for banner in subBanners %}
                        <li>
                            <a href="#" class="remove-banner delete-item" data-id="{{ banner.id }}"><span class="glyphicon glyphicon-remove"></span></a>
                            <img src="{{ banner.imageUrl }}" alt="{{ banner.title }}" title="{{ banner.title }}"/>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% else %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>类型</th>
                    <th>标题</th>
                    <th>目标ID</th>
                    <th>图片</th>
                    <th>创建日期</th>
                    <th width="1%">操作</th>
                </tr>
                </thead>
                <tbody>
                {% for subBanner in subBanners %}
                    <tr>
                        <td>{{ subBanner.id }}</td>
                        <td>{% spaceless %}
                            {% if subBanner.type == constant('Lychee\\Module\\Recommendation\\Entity\\SubBanner::TYPE_SPECIAL_SUBJECT') %}
                                专题
                            {% elseif subBanner.type == constant('Lychee\\Module\\Recommendation\\Entity\\SubBanner::TYPE_GAME') %}
                                游戏
                            {% endif %}
                        {% endspaceless %}</td>
                        <td>{{ subBanner.title }}</td>
                        <td>{{ subBanner.targetId }}</td>
                        <td><img src="{{ subBanner.imageUrl }}" alt="{{ subBanner.id }}"></td>
                        <td>{{ subBanner.createTime|date('Y-m-d H:i') }}</td>
                        <td style="white-space: nowrap;">
                            {% if subBanner.deleted == false %}
                                <button class="btn btn-primary publish-sub-banner" data-id="{{ subBanner.id }}">
                                    <span class="glyphicon glyphicon-send"></span>
                                    <span>发布</span>
                                </button>
                            {% endif %}
                            {% if subBanner.deleted == false %}
                                <button class="btn btn-danger delete-item" data-id="{{ subBanner.id }}">
                                    <span class="glyphicon glyphicon-trash"></span>
                                    <span>删除</span>
                                </button>
                            {% else %}
                                <button class="btn btn-danger recover-item" data-id="{{ subBanner.id }}">
                                    <span class="glyphicon glyphicon-repeat"></span>
                                    <span>恢复</span>
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <nav>
            {% set urlType = app.request.get('type') %}
            <ul class="pagination">
                {% set startPage = (page - 1) // pageCount * pageCount + 1 %}
                {% set lastPage = startPage + pageCount - 1 %}
                {% if page > 1 %}
                    <li>
                        <a href="{{ path('lychee_admin_manualintervention_subbanner', {
                            type: urlType,
                            page: 1
                        }) }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ path('lychee_admin_manualintervention_subbanner', {
                            type: urlType,
                            page: page - 1
                        }) }}" aria-label="Previous">
                            <span aria-hidden="true">上一页</span>
                        </a>
                    </li>
                {% endif %}
                {% for i in startPage..(lastPage > endPage? endPage:lastPage) %}
                    <li class="{{ i == page? 'active' }}"><a href="{{ path('lychee_admin_manualintervention_subbanner', {
                            type: urlType,
                            page: i
                        }) }}">{{ i }}</a></li>
                {% endfor %}
                {% if page != endPage %}
                    <li>
                        <a href="{{ path('lychee_admin_manualintervention_subbanner', {
                            type: urlType,
                            page: page + 1
                        }) }}" aria-label="Previous">
                            <span aria-hidden="true">下一页</span>
                        </a>
                    </li>
                    <li>
                        <a href="{{ path('lychee_admin_manualintervention_subbanner', {
                            type: urlType,
                            page: endPage
                        }) }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
    <!-- Modal -->
    <div class="modal fade" id="create_item_form" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">添加{{ subTitle }}</h4>
                    <form role="form" method="post" action="{{ path('lychee_admin_manualintervention_createsubbanner') }}">
                        <div class="modal-body">
                            <p class="text-danger">新增广告默认添加到“未发布”栏。</p>
                            <div class="form-group">
                                <label for="type">广告类型</label>
                                <select name="type" id="type" class="form-control">
                                    <option value="{{ constant('Lychee\\Module\\Recommendation\\Entity\\SubBanner::TYPE_SPECIAL_SUBJECT') }}"
                                            selected>
                                        专题
                                    </option>
                                    <option value="{{ constant('Lychee\\Module\\Recommendation\\Entity\\SubBanner::TYPE_GAME') }}">
                                        游戏
                                    </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="target_id">目标ID</label>
                                <input type="text" name="target_id" id="target_id" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="title">标题</label>
                                <input type="text" name="title" id="title" class="form-control">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">保 存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {%  javascripts '@LycheeAdminBundle/Resources/public/js/jquery.sortable.js' %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script>
        $(document).ready(function() {
            $('.delete-item, .recover-item').click(function() {
                if ($(this).hasClass('delete-item')) {
                    var confirmStr = '确定删除？';
                    var url = '{{ path("lychee_admin_manualintervention_removesubbanner") }}';
                } else {
                    var confirmStr = '确定恢复？';
                    var url = '{{ path("lychee_admin_manualintervention_recoversubbanner") }}';
                }
                if (confirm(confirmStr)) {
                    var $form = $('<form method="post"></form>');
                    $form.attr('action', url);
                    $form.append('<input type="hidden" name="id" value="' + $(this).data('id') + '">');
                    $(document.body).append($form);
                    $form.submit();
                }

                return false;
            });
            $('.publish-sub-banner').click(function() {
                if (confirm('确定发布？')) {
                    var $form = $('<form method="post"></form>');
                    $form.attr('action', '{{ path('lychee_admin_manualintervention_publishsubbanner') }}');
                    $form.append('<input type="hidden" name="id" value="' + $(this).data('id') + '">');
                    $(document.body).append($form);
                    $form.submit();
                }

                return false;
            });
            $('.unpublish-item').click(function() {
                if (confirm('确定下架？')) {
                    var $form = $('<form method="post"></form>');
                    $form.attr('action', '{{ path('lychee_admin_manualintervention_unpublishsubbanner') }}');
                    $form.append('<input type="hidden" name="id" value="' + $(this).data('id') + '">');
                    $(document.body).append($form);
                    $form.submit();
                }

                return false;
            });
            $(".sortable").sortable().bind("sortupdate", function() {
                var $subBanners = $(this).find("li a");
                var subBannerIds = [];
                $subBanners.each(function(index, elem) {
                    subBannerIds.push($(elem).data('id'));
                });
                $.ajax("{{ path('lychee_admin_manualintervention_sortsubbanner') }}", {
                    type: "POST",
                    data: {
                        sorted_ids: subBannerIds
                    },
                    dataType: "json",
                    error: function(jqXHR, textStatus, errorThrown) {
                        if (errorThrown) {
                            alert(errorThrown);
                        } else {
                            alert("发生未知错误");
                        }
                    }
                });
            });
            $('#target_id').on('blur', function() {
                var id = $(this).val();
                var type = $('#type').val();
                $.ajax('{{ path("lychee_admin_manualintervention_getsubbannertitle") }}', {
                    data: {
                        type: type,
                        id: id
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function(data) {
                        if ('undefined' != typeof data.title) {
                            $('#title').val(data.title);
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        td {
            vertical-align: middle !important;
        }
        .sortable {
            padding: 0;
            margin: 0;
        }
        .sortable li {
            list-style: none;
            display: block;
            border: 1px solid;
            width: 250px;
            margin: 5px 0;
            padding: 10px 5px;
        }
        .remove-banner { position: absolute; right: 5px; top: 5px; color: red; opacity: 0; transition: opacity 0.2s linear; }
        .remove-banner:visited { color: red; }
        .remove-banner:hover { color: red; }
        .remove-banner:active { color: red; }
        .add-banner { display: inline-block; width: 100%; height: 100%; }
        li:hover .remove-banner { opacity: 1; }
        .sortable .glyphicon-plus { color: white; line-height: 185px; font-size: 36px; }
        .sortable li {
            list-style: none;
            border: 1px solid #CCC;
            background: #F6F6F6;
            color: #1C94C4;
            margin: 5px;
            min-height: 185px;
            min-width: 320px;
            box-sizing: content-box;
            position: relative;
        }
        li.disabled { opacity: 0.5; }
        li.highlight { background: #FEE25F; }
        li.sortable-placeholder { border: 1px dashed #CCC; background: none; }
        .sortable.grid li { float: left; width: 80px; height: 80px; text-align: center; }
        .sortable.grid { overflow: hidden; }
        li img { max-height: 185px; max-width: 320px; }
    </style>
{% endblock %}