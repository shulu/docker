{% extends 'LycheeAdminBundle:Inquiry:layout.html.twig' %}
{% import 'LycheeAdminBundle::helper.html.twig' as helper %}

{% block body %}
    <button type="button" class="btn btn-primary pull-left" data-toggle="modal" data-target="#create_account">
        <span class="glyphicon glyphicon-plus"></span>
    </button>
    <div class="clearfix">
        <div class="col-lg-4 pull-right">
            <form>
                <div class="input-group">
                    <input type="text" name="query" class="form-control" placeholder="用户ID或昵称" value="{{ app.request.get('query')|default('') }}">
                <span class="input-group-btn">
                    <button class="btn btn-primary" type="submit">搜索</button>
                </span>
                </div><!-- /input-group -->
            </form>
        </div><!-- /.col-lg-6 -->
    </div>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>ID</th>
                <th>头像</th>
                <th>昵称</th>
                <th>邮箱/手机</th>
                <th>创建时间</th>
                <th>性别</th>
                <th>状态</th>
                <th>领主次元</th>
                <th><span class="glyphicon glyphicon-wrench"></span></th>
            </tr>
            </thead>
            <tbody>
                {% for userId in userIds %}
                    {% if users[userId] is defined %}
                        {% set user = users[userId] %}
                        <tr>
                            <td>
                                <a href="{{ path('lychee_admin_contentaudit_userdetail', {userId: user.id}) }}" target="_blank">
                                    {{ user.id }}
                                </a>
                            </td>
                            <td><img class="avatar-image" src="{{ user.avatarUrl }}" alt=""/></td>
                            <td>{{ user.nickname }}</td>
                            <td>{{ user.email }}/{{ user.phone }}</td>
                            <td>{{ user.createTime|date('Y-m-d H:i') }}</td>
                            <td>{{ user.gender == 1? '男' : '女' }}</td>
                            <td>
                                {% if true == user.frozen %}
                                    <span class="glyphicon glyphicon-ban-circle"></span>
                                {% else %}
                                    <span class="glyphicon glyphicon-ok"></span>
                                {% endif %}
                            </td>
                            <td>
                                {% for topic in managerTopics[user.id] %}
                                    <p>
                                        {% if topic %}
                                            <a href="{{ path('lychee_admin_topic_detail', {topicId: topic.id}) }}" target="_blank">
                                                {{ topic.title }}
                                            </a>
                                        {% else %}
                                            <a href="{{ path('lychee_admin_contentaudit_managertopics', {managerId: user.id}) }}" target="_blank">更多...</a>
                                        {% endif %}
                                    </p>
                                {% endfor %}
                            </td>
                            <td>
                                <button type="button" class="btn btn-default chat" data-user-id="{{ user.id }}"
                                        data-uesr-nickname="{{ user.nickname }}">
                                    <span class="glyphicon glyphicon-envelope"></span>
                                </button>
                                {% if false == user.frozen %}
                                    <button type="button" class="btn btn-danger black-list" uid="{{ user.id }}">
                                        <span class="glyphicon glyphicon-trash"></span>
                                    </button>
                                    <a href="{{ path('lychee_admin_contentaudit_postlistbyauthor', {'authorId': user.id}) }}"
                                        target="_blank">
                                        查看所有帖子
                                    </a>
                                {% else %}
                                    <button class="btn btn-default frozen_user_renew" user_id="{{ user.id }}">恢复</button>
                                {% endif %}
                                {% if user.id in deviceBlock %}
                                    <button class="btn btn-default device_unblock" data-user-id="{{ user.id }}">恢复设备</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}

            </tbody>
        </table>
        <nav>
            <ul class="pagination">
                <li>
                    <a href="{{ path('lychee_admin_inquiry_user', {query: query, page: 1}) }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% if pageCount < 1 %}{% set pageCount = 1 %}{% endif %}
                {% for p in 1..min(10, pageCount) %}
                    <li class="{{ p==page? 'active' }}">
                        <a href="{{ path('lychee_admin_inquiry_user', {query: query, page: p}) }}">{{ p }}</a>
                    </li>
                {% endfor %}
                <li>
                    <a href="{{ path('lychee_admin_inquiry_user', {query: query, page: pageCount}) }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="create_account" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">创建帐号</h4>
                </div>
                <form role="form" method="post" action="{{ path('lychee_admin_inquiry_createaccount') }}" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="account">电子邮箱或手机号</label>
                            <input type="text" class="form-control" id="account" name="account" placeholder="Email/Phone">
                        </div>
                        <div class="form-group">
                            <label for="nickname">昵称</label>
                            <input type="text" class="form-control" id="nickname" name="nickname">
                        </div>
                        <div class="form-group">
                            <label for="gender">性别</label>
                            <select name="gender" id="gender" class="form-control">
                                <option value="{{ genderMale }}">男</option>
                                <option value="{{ genderFemale }}">女</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="avatar">头像</label>
                            <input type="file" class="form-control avatar" name="avatar" id="avatar">
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="create_password" name="create_password">
                            <label for="create_password">&nbsp;创建密码</label>
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" class="form-control" id="password" name="password" disabled>
                        </div>
                        <div class="form-group">
                            <label for="retype_password">确认密码</label>
                            <input type="password" class="form-control" id="retype_password" name="retype_password" disabled>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">确 定</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {{ helper.chatWin(ciyoUser) }}
    {{ helper.freeUser() }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets '@fileinput_css' filter="cssrewrite" %}
        <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
    <style>
        .avatar-image{ height: 50px; }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% javascripts '@fileinput_js' %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    <script>
        $(document).ready(function() {
            var $password = $("#password");
            var $retypePassword = $("#retype_password");
            var $createAccountForm = $("#create_account");
            var $account = $("#account");
            $("#avatar").fileinput({
                allowedFileTypes: ['image'],
                showUpload: false
            });

            $("#create_password").on("click", function() {
                if (this.checked) {
                    $password.removeAttr("disabled");
                    $retypePassword.removeAttr("disabled");
                } else {
                    $password.attr("disabled", "disabled");
                    $retypePassword.attr("disabled", "disabled");
                }
            });
            $createAccountForm.find("button[type=submit]").on("click", function() {
                if (!$account.val()) {
                    alert("请输入电子邮箱或手机号！");

                    return false;
                } else if (false === /^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]+$/.test($account.val()) && false === /^\d+$/.test($account.val())) {
                    alert("既不是Email，也不是手机号");

                    return false;
                }
                if (!$("#nickname").val()) {
                    alert("请输入昵称！");

                    return false;
                }
                if ($password.val() !== $retypePassword.val()) {
                    alert("两次密码不相同！");

                    return false;
                }
            });
            $(".frozen_user_renew").on("click", function() {
                if (true === confirm("确定恢复此帐号？")) {
                    $.ajax("{{ path('lychee_admin_contentaudit_unfreezeuser') }}", {
                        type: "POST",
                        dataType: "json",
                        data: {
                            user_id: $(this).attr("user_id")
                        },
                        success: function() {
                            window.location.reload();
                        },
                        error: function() {
                            alert("发生未知错误！");
                        }
                    });
                }
            });

            $('.device_unblock').click(function() {
                if (!confirm('确定恢复用户设备？')) {
                    return false;
                }
                var userId = $(this).data('user-id');
                var $form = $('<form method="post"></form>');
                $form.attr('action', '{{ path("lychee_admin_contentaudit_unblockdevice") }}');
                $form.append('<input type="hidden" name="user_id" value="' + userId + '">');
                $('body').append($form);
                $form.submit();
            });
        });
    </script>
{% endblock %}